{% extends "rsvp/base.html" %}

{% block rsvp_content %}
  <!-- Save the Date Video Modal -->
  <div x-data="{ 
         showModal: (() => {
           // Check for query parameter bypass
           const urlParams = new URLSearchParams(window.location.search);
           if (urlParams.get('skip_sdt') === '1') {
             console.debug('[RSVP] SDT modal bypassed via query param');
             return false;
           }
           
           // Check if already seen in this session
           const alreadySeen = sessionStorage.getItem('rsvp_sdt_modal_seen') === '1';
           if (alreadySeen) {
             console.debug('[RSVP] SDT modal seen:', true);
             return false;
           }
           
           // First visit - show modal and mark as seen
           sessionStorage.setItem('rsvp_sdt_modal_seen', '1');
           console.debug('[RSVP] SDT modal seen:', false, '(showing for first time)');
           return true;
         })()
       }" 
       x-show="showModal" 
       x-transition:enter="transition ease-out duration-300"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition ease-in duration-200"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0"
       class="modal-backdrop"
       @click.self="showModal = false"
       @keydown.escape.window="showModal = false"
       x-cloak>
    
    <div class="modal-container"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform scale-100"
         x-transition:leave-end="opacity-0 transform scale-95">
      
      <!-- Close Button -->
      <button @click="showModal = false" 
              class="modal-close-btn"
              aria-label="Close modal">
        Ã—
      </button>
      
      <!-- Modal Content -->
      <div class="modal-content">
        <h2 class="modal-title">Save the Date!</h2>
        <p class="modal-subtitle">Watch Kelly & John's Save the Date Video</p>
        
        <!-- Vimeo Video Embed -->
        <div class="video-container">
          <iframe src="https://player.vimeo.com/video/1114717262?badge=0&autopause=0&player_id=0&app_id=58479" 
                  frameborder="0" 
                  allow="autoplay; fullscreen; picture-in-picture; clipboard-write; encrypted-media; web-share" 
                  referrerpolicy="strict-origin-when-cross-origin" 
                  title="Kelly and John - Save the Date!">
          </iframe>
        </div>
        
        <p class="modal-instruction" style="font-size: 1rem; margin-top: 1rem;">
          Close this window to continue with your RSVP
        </p>
      </div>
    </div>
  </div>

  <!-- RSVP Form Content -->
  <p class="celebration-text">We can't wait to celebrate with you!</p>
  <h2>Who's RSVPing?</h2>
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Search</button>
  </form>
{% endblock %}